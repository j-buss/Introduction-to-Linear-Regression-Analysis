---
title: "Chapter 02 Problems - Using rstudio"
output: html_document
---

# Load Libraries
Only need to run the following installs once. Therefore commented after the first run.
```{r}
#install.packages(c("readxl","ggplot2", "ggpubr", "tidyverse", "broom", "AICcmodavg"))
```
```{r}
library(readxl)
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(broom)
library(AICcmodavg)
```
## Functions
```{r}
PlotBands <- function(DataFrame, LinearModel, ...){
    #get predicted y values using regression equation
    newx <- seq(min(DataFrame$x), max(DataFrame$x), length.out=100)

    #calculate the confidence interval values
    conf <- predict(LinearModel, newdata = data.frame(x=newx), interval = 'confidence', level=0.95)

    #calculate the prediction interval values
    pred <- predict(LinearModel, newdata = data.frame(x=newx), interval = 'predict', level=0.95)
  
    #create plot of x vs. y, but don't display individual points (type='n') 
    ########### Add flexibility to this plot function..
    plot(y ~ x, data = DataFrame, type='n', ylim=c(min(pred[,2]),max(pred[,3])),...)
    #############

    #add polygon: Confidence Interval Upper -> Prediction Interval Upper
    polygon(c(rev(newx), newx), c(rev(conf[ ,3]), pred[ ,3]), col = 'pink', border = NA)

    #add polygon: Predicted Values -> Confidence Interval Upper
    polygon(c(rev(newx), newx), c(rev(conf[ ,3]), conf[ ,1]), col = 'gray85', border = NA)

    #add polygon: Predicted Values -> Confidence Interval Lower
    polygon(c(rev(newx), newx), c(rev(conf[ ,2]), pred[ ,2]), col = 'pink', border = NA)

    #add polygon: Confidence Interval Lower -> Prediction Interval Lower
    polygon(c(rev(newx), newx), c(rev(conf[ ,2]), conf[ ,1]), col = 'gray85', border = NA)

    #add line: Regression
    abline(LinearModel, lwd=1.5)

    #add line: Confidence Interval Upper
    lines(newx, conf[ ,3], lty = 'dashed', col = 'gray5', lwd=1.5)
    #add line: Confidence Interval Lower
    lines(newx, conf[ ,2], lty = 'dashed', col = 'gray5', lwd=1.5)

    #add line: Prediction Interval Upper
    lines(newx, pred[ ,3], lty = 'dashed', col = 'red4', lwd=1.5)
    #add line: Prediction Interval Upper
    lines(newx, pred[ ,2], lty = 'dashed', col = 'red4', lwd=1.5)
}

LMStandardAnalysis <- function(DataFrame, LinearModel, Probability, AddLine=TRUE, ...){
  ReturnList = list()
  ReturnList$Summary <- summary(LinearModel)
  ReturnList$Anova <- anova(LinearModel)
  ReturnList$MSres <- ReturnList$Anova['Residuals','Mean Sq']
  ReturnList$RSqrd <- ReturnList$Summary$r.squared
  ReturnList$t_0 <- ReturnList$Summary$coefficients['x','t value']
  # The qt function returns the values for an 1-tail / upper-tail distribution
  #   Therefore the input probability needs to be adjusted
  adjProbability <- (1 - (1 - Probability)/2)
  ReturnList$t_alpha <- qt(adjProbability, df=nrow(DataFrame))
  ReturnList$t_RejectNull <- (abs(ReturnList$t_0) > ReturnList$t_alpha)
  ReturnList$fstatistic <- unname(ReturnList$Summary$fstatistic[1])
  ReturnList$pvalue <- ReturnList$Summary$coefficients['x','Pr(>|t|)']
  ReturnList$Intercept <- ReturnList$Summary$coefficients['(Intercept)','Estimate']
  ReturnList$Slope <- ReturnList$Summary$coefficients['x','Estimate']
  
  plot(DataFrame$x, DataFrame$y,...)
  if(AddLine){
    abline(LinearModel)
  }
  return(ReturnList)
  
}
```
# Problems
## 2.16
```{r}
Pressure <- list()

Pressure$DataTable <- read_excel('../linear_regression_5e_data_sets/Chapter 2/Problems/data-prob-2-16.xls')

Pressure$df <- data.frame(
    x=Pressure$DataTable$'Volume', 
    y=Pressure$DataTable$'Pressure')

head(Pressure$df)

Pressure$lm <- lm(y ~ x, data=Pressure$df)
```
```{r}
PressureLM <- LMStandardAnalysis(Pressure$df, Pressure$lm, Probability = .95, xlab="Volume", ylab="Pressure")
```
```{r}
PressureLM
```

```{r}
PlotBands(Pressure$df, Pressure$lm)
```


The result of the linear model analysis confirms that this is a perfect relationship. 
* The RSquared term is ~1 and the Residual Mean Squared is extremely small. 
* The confidence intervals are extremely small, essentially non existent.
* We reject the Null hypothesis
This set of data essentially describes a perfect relationship.

## 2.17
```{r}
BarometricPressure <- list()

BarometricPressure$DataTable <- read_excel('../linear_regression_5e_data_sets/Chapter 2/Problems/data-prob-2-17.xls')

BarometricPressure$df <- data.frame(
    y=BarometricPressure$DataTable$'Boiling Point (F)', 
    x=BarometricPressure$DataTable$'Barometric Pressure (in Hg)')

head(BarometricPressure$df)

BarometricPressure$lm <- lm(y ~ x, data=BarometricPressure$df)
```
```{r}
BarometricPressureLM <- LMStandardAnalysis(BarometricPressure$df, BarometricPressure$lm, Probability = .95, 
                                           ylab="Boiling Point (F)", xlab="Barometric Pressure (in Hg)")
```

```{r}
BarometricPressureLM
```
The linear model is a very good fit for the data. 


## 2.18
```{r}
MediaImpressions <- list()

MediaImpressions$DataTable <- read_excel('../linear_regression_5e_data_sets/Chapter 2/Problems/data-prob-2-18.xls')

MediaImpressions$df <- data.frame(
    y=MediaImpressions$DataTable$'Returned Impressions per week (millions)', 
    x=MediaImpressions$DataTable$'Amount Spent (Millions)')

head(MediaImpressions$df)
MediaImpressions$lm <- lm(y ~ x, data=MediaImpressions$df)
```
```{r}
MediaImpressionsLM <- LMStandardAnalysis(MediaImpressions$df, MediaImpressions$lm, Probability = .95, 
                                           ylab="Returned Impressions per week (millions)", xlab="Amount Spent (millions)")
```
```{r}
MediaImpressionsLM
```

### a
There seems to be a relationship there. The more money spent, the more impressions.

The relationship between money and impressions is the following:

Media Impressions = `r MediaImpressionsLM$Slope` * (Amount Spent) + `r MediaImpressionsLM$Intercept`


### b
 With the F-statistics of `r MediaImpressionsLM$fstatistic` and a p value of `r MediaImpressionsLM$pvalue` it is statistically significant. However with an R-squared of just `r MediaImpressionsLM$RSqrd` there is a lot of unexplained variance.

### c

```{r}
PlotBands(MediaImpressions$df, MediaImpressions$lm, 
          ylab="Returned Impressions per week (millions)", xlab="Amount Spent (millions)",
          main="Returned Impressions per week (millions) vs. Amount Spent (millions)",
          sub=paste("Media Impressions = ",round(MediaImpressionsLM$Intercept,4)," + ",round(MediaImpressionsLM$Slope,4)," * Amount Spent (in millions)",sep="")
          )
legend("topleft",
       legend=c("Regression","Prediction","Confidence"),
       col=c("black","red4","gray5"),
       lty=c("solid","dashed","dashed"),
       lwd=1.5
)

```

### d
```{r}
MCI_CI <- predict(MediaImpressions$lm, data.frame(x = c(26.9)), interval="confidence", level=0.95)
PointPrediction <- MCI_CI[1]
```
```{r}
x_0 <- 26.9
x_bar <- mean(MediaImpressions$df$x)
n <- nrow(MediaImpressions$df)
t_alpha <- qt(.975, df=(n-2))
S_xx <- sum(MediaImpressions$df$x^2) - ((sum(MediaImpressions$df$x))^2)/n
ConfIntervalOnMean_Above <- PointPrediction + t_alpha * (sqrt(MediaImpressionsLM$MSres * (1/n + ((x_0 - x_bar)^2)/S_xx)))
ConfIntervalOnMean_Below <- PointPrediction - t_alpha * (sqrt(MediaImpressionsLM$MSres * (1/n + ((x_0 - x_bar)^2)/S_xx)))
```

The predicted value of retained impressions from MCI at Spending Level of `r x_0` is: `r round(PointPrediction,4)`

The corresponding confidence interval is: ( `r round(MCI_CI[2],4)`,`r round(MCI_CI[3],4)`)


```{r}
MCI_PI <- predict(MediaImpressions$lm, data.frame(x = c(26.9)), interval="prediction", level=0.95)
```

```{r}
x_0 <- 26.9
x_bar <- mean(MediaImpressions$df$x)
n <- nrow(MediaImpressions$df)
t_alpha <- qt(.975, df=(n-2))
S_xx <- sum(MediaImpressions$df$x^2) - ((sum(MediaImpressions$df$x))^2)/n
PredictInterval_Above <- PointPrediction + t_alpha * (sqrt(MediaImpressionsLM$MSres * (1 + 1/n + ((x_0 - x_bar)^2)/S_xx)))
PredictInterval_Below <- PointPrediction - t_alpha * (sqrt(MediaImpressionsLM$MSres * (1 + 1/n + ((x_0 - x_bar)^2)/S_xx)))
```
The Prediction Interval for the number of retained impressions from MCI at Spending Level of `r x_0` is: ( `r round(MCI_PI[2],4)`,`r round(MCI_PI[3], 4)`)
## 2.19
```{r}
PatientSatAge <- list()

PatientSatAge$DataTable <- read_excel('../linear_regression_5e_data_sets/Appendices/data-table-B17.xls')

PatientSatAge$df <- data.frame(
    y=PatientSatAge$DataTable$'Satisfaction', 
    x=PatientSatAge$DataTable$'Age')

head(PatientSatAge$df)
PatientSatAge$lm <- lm(y ~ x, data=PatientSatAge$df)
```
```{r}
PatientSatAgeLM <- LMStandardAnalysis(PatientSatAge$df, PatientSatAge$lm, Probability = .95, 
                                           ylab="Satisfaction", xlab="Age (years")
```
```{r}
PatientSatAgeLM
```

### a

The equation for the model is : Satisfaction = `r PatientSatAgeLM$Intercept` + `r PatientSatAgeLM$Slope` * Age

The model relating Satisfaction to Age provides a good fit with an R-squared value of `r round(PatientSatAgeLM$RSqrd,4)`. Additionally the p-value is very small at `r PatientSatAgeLM$pvalue` and the Residual Mean Squared term is `r round(PatientSatAgeLM$MSres, 4)` and F-statistic of `r round(PatientSatAgeLM$fstatistic,4)`

### b
The model relating Satisfaction to Age is a better fit than the original model in section 2.7 which had a Residual Mean Squared term of 270.02 and a F-statistic of 17.1114 vs. the values of `r round(PatientSatAgeLM$MSres, 4)` and F-statistic of `r round(PatientSatAgeLM$fstatistic,4)`

# 2.20
```{r}
FuelBoilingPoint <- list()

FuelBoilingPoint$DataTable <- read_excel('../linear_regression_5e_data_sets/Appendices/data-table-B18.xls')

FuelBoilingPoint$df <- data.frame(
    y=FuelBoilingPoint$DataTable$'y', 
    x=FuelBoilingPoint$DataTable$'x_5')

head(FuelBoilingPoint$df)
FuelBoilingPoint$lm <- lm(y ~ x, data=FuelBoilingPoint$df)
```
```{r}
FuelBoilingPointLM <- LMStandardAnalysis(FuelBoilingPoint$df, FuelBoilingPoint$lm, Probability = .95, 
                                           ylab="Fuel Consumption", xlab="Fuel - Initial Boiling Point")
```
```{r}
FuelBoilingPointLM
```
The equation for the model is : FuelConsumption = `r FuelBoilingPointLM$Intercept` + `r FuelBoilingPointLM$Slope` * Fuel - Initial Boiling Point

The engineer is correct that there is a relationship between Fuel Initial Boiling Point to Fuel consumption. However with a value of R-squared value: `r round(PatientSatAgeLM$RSqrd,4)` the model has a significant amount of unexplained variation.

# 2.21
```{r}
WineSulphur <- list()

WineSulphur$DataTable <- read_excel('../linear_regression_5e_data_sets/Appendices/data-table-B19.xls')

WineSulphur$df <- data.frame(
    y=WineSulphur$DataTable$'y', 
    x=WineSulphur$DataTable$'x_3')

head(WineSulphur$df)
WineSulphur$lm <- lm(y ~ x, data=WineSulphur$df)
```
```{r}
WineSulphurLM <- LMStandardAnalysis(WineSulphur$df, WineSulphur$lm, Probability = .95, 
                                           ylab="Quality", xlab="SO_2 Content")
```
```{r}
WineSulphurLM
```
Yes. It appears that the sulfur content of wine has a negative impact on the quality. With a p-value of `r round(WineSulphur,4)` the model does have a statistically significant relationship. However the r-squared value of `r rount(WineSulphurLM$RSqrd,4)` this is significant amount of variation that is not explained in the model.

# 2.22

```{r}
MethanolOxidation <- list()

MethanolOxidation$DataTable <- read_excel('../linear_regression_5e_data_sets/Appendices/data-table-B20.xls')

MethanolOxidation$df <- data.frame(
    y=MethanolOxidation$DataTable$'y', 
    x=MethanolOxidation$DataTable$'x_5')

head(MethanolOxidation$df)
MethanolOxidation$lm <- lm(y ~ x, data=MethanolOxidation$df)
```

```{r}
MethanolOxidationLM <- LMStandardAnalysis(MethanolOxidation$df, MethanolOxidation$lm,
                                          Probability = .95, xlab="Ratio of Inlet Oxygen to Inlet Methanol",
                                          ylab="Conversion Process")
```
```{r}
MethanolOxidationLM
```
The chemist's belief appears to be unfounded. The p-value of `r round(MethonalOxidationLM$pvalue,4)` is too large, the f-statistic is too small at `r round(MethonalOxidationLM$fstatistic,4)`. More precisely, the t_0 value of `r round(MethonalOxidationLM$t_0,4)` is smaller than the t_alpha value of `r round(MethonalOxidationLM$t_alpha,4)` and therefore we reject the null hypothesis. Lastly, the r-squared value of `r round(MethonalOxidationLM$RSqrd, 4)` shows that the model explains extremely little of the variation.
